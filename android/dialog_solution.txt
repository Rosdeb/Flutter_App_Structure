SOLUTION FOR LISTVIEW IN DIALOG:

The issue is that ListView has infinite height constraints in a dialog. Here's how to fix it:

1. Wrap the ListView in an Expanded widget
2. Or use a SizedBox with fixed height
3. Or use SingleChildScrollView with Column instead of ListView

Here's the corrected code for your dialog:

// For Apple Plans in Dialog
Widget _buildApplePlansInDialog(List<ProductDetails> appleProducts) {
  return SizedBox(
    height: 200, // Fixed height for dialog
    child: ListView.builder(
      scrollDirection: Axis.horizontal,
      padding: EdgeInsets.symmetric(horizontal: 8.w),
      itemCount: appleProducts.length,
      itemBuilder: (context, index) {
        return Obx(() {
          final isSelected = updatePlan.selectedIndex.value == index;
          final product = appleProducts[index];
          final planName = product.id.contains('month') ? 'Monthly' : 'Yearly';
          final price = product.price;
          final isYearly = product.id.contains('year');

          return GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
              updatePlan.selectedIndex.value = index;
              updatePlan.selectedPrice.value = product.rawPrice.toString();

              if (product.id.contains('month')) {
                updatePlan.selectedType.value = 'Monthly';
              } else if (product.id.contains('year')) {
                updatePlan.selectedType.value = 'Yearly';
              }

              updatePlan.discountedPrice.value = 0.0;

              debugPrint("✅ Selected Apple Plan: $planName");
              debugPrint("✅ Apple Price: $price (${product.rawPrice})");
              debugPrint("✅ Product ID: ${product.id}");
            },
            child: Container( // Changed from AnimatedContainer for dialog performance
              padding: const EdgeInsets.symmetric(horizontal: 12),
              margin: EdgeInsets.only(right: 12.w),
              decoration: BoxDecoration(
                gradient: isSelected
                    ? const LinearGradient(
                  colors: [Color(0xFFFFE5EE), Color(0xFFFFF0F5)],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                )
                    : null,
                color: isSelected ? null : const Color(0xFFF5F5F5),
                borderRadius: BorderRadius.circular(12.r),
                border: Border.all(
                  width: isSelected ? 2.w : 1.w,
                  color: isSelected
                      ? const Color(0xFFE32B6B)
                      : const Color(0xFFE0E0E0),
                ),
                boxShadow: isSelected
                    ? [
                  BoxShadow(
                    color: const Color(0xFFE32B6B).withOpacity(0.15),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                    spreadRadius: 0,
                  ),
                ]
                    : [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.03),
                    blurRadius: 4,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  AppText(
                    planName,
                    fontSize: 14.sp,
                    fontWeight: FontWeight.w700,
                    color: isSelected
                        ? const Color(0xFFE32B6B)
                        : const Color(0xFF1A1A1A),
                  ),
                  SizedBox(height: 4.h),
                  Row(
                    mainAxisSize: MainAxisSize.min,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      AppText(
                        price,
                        fontSize: 16.sp,
                        fontWeight: FontWeight.w800,
                        color: isSelected
                            ? const Color(0xFFE32B6B)
                            : const Color(0xFF333333),
                      ),
                      if (isYearly) ...[
                        SizedBox(width: 2.w),
                        AppText(
                          '/year',
                          fontSize: 8.sp,
                          fontWeight: FontWeight.w500,
                          color: const Color(0xFF999999),
                        ),
                      ] else ...[
                        SizedBox(width: 2.w),
                        AppText(
                          '/month',
                          fontSize: 8.sp,
                          fontWeight: FontWeight.w500,
                          color: const Color(0xFF999999),
                        ),
                      ],
                    ],
                  ),
                  SizedBox(height: 4.h),
                  if (isYearly)
                    Row(
                      children: [
                        Icon(
                          Icons.star_rounded,
                          size: 12.sp,
                          color: const Color(0xFFFFA726),
                        ),
                        SizedBox(width: 2.w),
                        AppText(
                          'Best Value',
                          fontSize: 9.sp,
                          fontWeight: FontWeight.w600,
                          color: const Color(0xFFFFA726),
                        ),
                      ],
                    )
                  else
                    AppText(
                      'Popular',
                      fontSize: 9.sp,
                      fontWeight: FontWeight.w600,
                      color: const Color(0xFF999999),
                    ),
                ],
              ),
            ),
          );
        });
      },
    ),
  );
}

// For Backend Plans in Dialog
Widget _buildBackendPlansInDialog() {
  return SizedBox(
    height: 150, // Fixed height for dialog
    child: ListView.builder(
      scrollDirection: Axis.horizontal,
      padding: EdgeInsets.symmetric(horizontal: 10.w),
      itemCount: updatePlan.subscriptionlist.length,
      itemBuilder: (context, index) {
        return Obx(() {
          final isSelected = updatePlan.selectedIndex.value == index;
          final plan = updatePlan.subscriptionlist[index];
          final planName = plan.name?.toString() ?? 'Unknown';
          final planPrice = plan.price?.toString() ?? '0';
          final subscriptionType = plan.subscriptionType?.toString() ?? "Monthly";

          return GestureDetector(
            onTap: () {
              updatePlan.selectedIndex.value = index;
              updatePlan.selectedPrice.value = planPrice;
              updatePlan.selectedType.value = subscriptionType;
              updatePlan.discountedPrice.value = 0.0;

              debugPrint("✅ Selected Backend Plan: $planName");
              debugPrint("✅ Backend Price: €$planPrice");
              debugPrint("✅ Subscription Type: $subscriptionType");
            },
            child: Container(
              padding: const EdgeInsets.all(12),
              margin: EdgeInsets.symmetric(horizontal: 6.w),
              decoration: BoxDecoration(
                color: isSelected ? Colors.pink[50] : const Color(0xFFEEEEEE),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  width: 1.5,
                  color: isSelected ? Colors.pink : const Color(0xFF111111),
                ),
                boxShadow: isSelected
                    ? [
                  BoxShadow(
                    color: Colors.pink.withOpacity(0.3),
                    blurRadius: 6,
                    offset: const Offset(0, 3),
                  ),
                ]
                    : null,
              ),
              child: Center(
                child: AppText(
                  "$planName €$planPrice",
                  fontSize: 14.sp,
                  fontWeight: FontWeight.w600,
                  color: isSelected ? Colors.pink : Colors.black,
                ),
              ),
            ),
          );
        });
      },
    ),
  );
}

// How to use in your dialog:
showDialog(
  context: context,
  builder: (BuildContext context) {
    return AlertDialog(
      title: Text("Select Plan"),
      content: Container(
        width: double.maxFinite, // This makes it centered with max width
        child: _buildApplePlansInDialog(appleProducts), // or _buildBackendPlansInDialog()
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(),
          child: Text("Cancel"),
        ),
        TextButton(
          onPressed: () {
            // Handle selection
            Navigator.of(context).pop();
          },
          child: Text("Select"),
        ),
      ],
    );
  },
);